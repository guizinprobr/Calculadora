#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define MAX 1000

int main() {
    FILE *ponteiro;
    int op, i = 0, qtd[MAX], qtdr, encontrado;
    char item[MAX][50], resposta, itemremover[50];

    // Carrega o estoque do arquivo (se existir)
    ponteiro = fopen("estoque.txt", "r");
    if (ponteiro != NULL) {
        while (fscanf(ponteiro, "%s %d", item[i], &qtd[i]) == 2) {
            i++;
        }
        fclose(ponteiro);
    }

    do {
        system("cls");
        printf("=====================\n");
        printf("CONTROLE DE ESTOQUE\n");
        printf("=====================\n\n");
        printf("1. Adicionar item\n");
        printf("2. Remover item\n");
        printf("3. Listar estoque\n");
        printf("4. Sair\n\n");
        printf("Escolha uma opcao: ");
        scanf("%d", &op);

        switch (op) {
            case 1:
                printf("Digite o nome do item: ");
                scanf(" %s", item[i]);
                printf("Digite a quantidade: ");
                scanf("%d", &qtd[i]);

                i++; // avança para próxima posição

                // Salva imediatamente no arquivo
                ponteiro = fopen("estoque.txt", "w");
                for (int j = 0; j < i; j++) {
                    fprintf(ponteiro, "%s %d\n", item[j], qtd[j]);
                }
                fclose(ponteiro);

                printf("Item adicionado com sucesso!\n");
                break;

            case 2:
                printf("Digite o nome do item a ser removido: ");
                scanf(" %s", itemremover);
                encontrado = 0;

                for (int j = 0; j < i; j++) {
                    if (strcmp(item[j], itemremover) == 0) {
                        printf("Digite a quantidade a ser removida: ");
                        scanf("%d", &qtdr);

                        if (qtdr > qtd[j]) {
                            printf("Quantidade maior que o estoque! (%d disponivel)\n", qtd[j]);
                        } else {
                            qtd[j] -= qtdr;
                            printf("Quantidade atualizada. Novo total: %d\n", qtd[j]);
                            if (qtd[j] == 0) {
                                // Remove item deslocando os vetores
                                for (int k = j; k < i - 1; k++) {
                                    strcpy(item[k], item[k + 1]);
                                    qtd[k] = qtd[k + 1];
                                }
                                i--; // reduz total de itens
                                printf("Item removido do estoque!\n");
                            }
                        }
                        encontrado = 1;
                        break;
                    }
                }

                if (!encontrado) {
                    printf("Item nao encontrado.\n");
                }

                // Atualiza o arquivo
                ponteiro = fopen("estoque.txt", "w");
                for (int j = 0; j < i; j++) {
                    fprintf(ponteiro, "%s %d\n", item[j], qtd[j]);
                }
                fclose(ponteiro);

                break;

            case 3:
                if (i == 0) {
                    printf("Estoque vazio.\n");
                } else {
                    printf("===== ESTOQUE ATUAL =====\n");
                    printf("Nome\t\tQuantidade\n");
                    printf("-------------------------\n");
                    for (int j = 0; j < i; j++) {
                        printf("%-15s %d\n", item[j], qtd[j]);
                    }
                }
                break;

            case 4:
                printf("Saindo...\n");
                break;

            default:
                printf("Opcao invalida!\n");
                break;
        }

        if (op != 4) {
            printf("\nDeseja realizar outra operacao? (s/n): ");
            scanf(" %c", &resposta);
        } else {
            resposta = 'n';
        }

    } while (resposta == 's' || resposta == 'S');

    printf("Obrigado por usar o estoque!\n");
    return 0;
}
